# DonateQuest
## Введение
В современном мире набирают всё большую популярность стриминговые платформы, на которых люди в режиме реального времени транслируют различный контент: образовательный, игровой или социальный.
Раньше люди шли в стриминг ради развлечения или общения, в настоящее же время стример - полноценная профессия, которая требует профессиональных навыков и может приносить доход.
Одними из основных способов заработка стримеров являются:
1. Разные формы рекламы, начиная от нативных интеграций, заканчивая полноценными рекламными заказами от крупных брендов. Чаще встречается у средних и крупных стримеров.
2. Донаты - добровольные пожертвования от зрителей. Встречаются у всех категорий стримеров.

В последнее время начали набирать популярность различные донат интерактивы, когда зритель, поддержав стримера, может повлиять как-то на ход трансляции. Примером подобных интерактивов являются различные донат аукционы на выбор игры/фильма.
Первопроходцами в данном направлении стали игровые стримеры, которые смогли интегрировать донат интерактив в игровой процесс. Это влияние может отличаться: некоторые игры, поддерживающие модификацию, имеют готовые решения для подобной активности, в некоторых случаях стримеры сами придумывают список заданий-вызовов для себя и вручную отслеживают приходящие донаты.

В сообществе одного моего знакомого игрового стримера появились идеи подобных заданий для немодифицируемой игры. Одной из основных игр на его канале является DreadHunger - социальный кооператив с элементами песочницы. По сюжету игры, команда - участники британской экспедиции, которые исследуют суровые воды арктики. Главная цель игроков - выбраться из залива, выход из которого преграждает огромный айсберг. Мешать игрокам будут погодные условия, хищники и пара предателей-игроков, которые затесались в команде. Благодаря чётко установленным целям каждого участника экспедиции, элементам выживания-песочницы и социальному характеру игры, существует возможность продумывать различные сценарии происходящего и на основе этого формировать задания.

Большинство аналогов были направлены только на взаимодействие со стримеров и влияли по большей степени не на игровой процесс, а на взаимодействие игрока с игрой: инверсировали управление, переворачивали экран игры и так далее. Также не существует аналогов, поддерживающих таргетирование задания, когда зритель может выбрать кому именно оно будет адресовано.

Целью работы является создание универсального сервиса создания донат заданий стримеров.
Исходя из данной цели, были поставлены следующие задачи: 
1. Спроектировать базу данных
2. Организовать получение данных о новых донатах из платёжной системы
3. Разработать интерфейс-обёртку для платёжных страниц стримеров 
4. Создать виджет уведомлений о новых заданиях
5. Организовать уведомление стримера/игроков о новых заданиях

## Список требований
1. Страница-обёртка платёжной системы с актуальным списком заданий игроков
2. Получение уведомлений о новых донатах из платёжной системы DonationAlert
3. Отправка заданий и администрирование системы посредством интеграции в Discord
4. Отображение новых заданий в виджете на трансляции
5. Поддержка парных заданий
6. Поддержка командных заданий

## Стек технологий
Backend: NodeJS, TypeScript, sequalize-typescript (MySQL), socket.io, discord api, centrifuge, 

Frontend: React, Next, socket.io-client, emotion/styled, react-notifications-component

## Реализованная функциональность
Была разработана система, поддерживающая возможность создавать интерактивы для различных стримеров и игр. 

### Основная логика
Для получения уведомлений о новых донатах используется DonationAlert API, а именно разворачивается centrifugo websocket клиент с их эндпоинтом. 
Приходящие уведомления парсятся: сначала система проверяем наличие у данного стримера донат задания по стоимости доната, далее пытается распознавать в сообщение имя игрока, к которому обращено задание. 
Предусмотрена логика распознания игроков и в случае парных заданий: первый найденный игрок становится исполнителем, а второй - его целью.
В случае нехватки необходимых параметров-игроков, система выбирает случайного, наименее загруженного заданиями игрока.
Задание заносится в базу данных и отправляется к игроку.

### Сайт интерактива
<img src="/img/site.png?raw=true">

На странице стримера в центре экрана расположен блок платёжной системы DonationAlert.
<img src="/img/donate.png?raw=true" width="50%">

С правого края расположен блок с раскрывающимися списками заданий.
<img src="/img/quests.png?raw=true" width="50%">

Слева указан список команды с возможностью просмотра количества активных заданий у каждого из игроков.
<table>
  <tr>
    <td><img src="/img/players.png?raw=true" width="100%"></td>
    <td><img src="/img/player.png?raw=true" width="100%"></td>
   </tr>
</table>

Для адаптации пользователей разработан гайд по использованию системы. При первом посещении сайта он появляется автоматически, при последующих, пользователи могут вызвать его по нажатию на соотвествующую кнопку.
<img src="/img/guide.png?raw=true" width="100%">

Для категорий заданий Парные и Командные осуществлены всплывающие подсказки при наведении.
<table>
  <tr>
    <td><img src="/img/hint1.png?raw=true" width="100%"></td>
    <td><img src="/img/hint2.png?raw=true" width="100%"></td>
   </tr>
</table>

В случае, если донат интерактив отключён - вместо списка игроков отображается соотвествующее сообщение.

<img src="/img/offline.png?raw=true" width="50%">

Сайт полностью адаптирован под мобильные устройства.
<table>
  <tr>
    <td><img src="/img/adaptive1.png?raw=true" width="100%"></td>
    <td><img src="/img/adaptive3.png?raw=true" width="100%"></td>
    <td><img src="/img/adaptive2.png?raw=true" width="100%"></td>
    <td><img src="/img/adaptive4.png?raw=true" width="100%"></td>
   </tr>
</table>


Сайт размещён на хостинге, в качестве веб-сервера используется nginx, зарегистрирован домен (donatequest.ru) и на него оформлен DomainSSL сертификат.
Для дополнительной защиты и кеширования сайта используется сервис Cloudflare.

### Дискорд бот
Бот присылает игрокам уведомления о новых заданиях.

Разработан ряд команд:
1. /player add @User - Добавление нового игрока, при вызове всплывает модальное окно для заполнения полей: отображаемое имя игрока и список ассоциаций к нему.
<table>
  <tr>
    <td><img src="/img/playerAdd.png?raw=true" width="100%"></td>
    <td><img src="/img/playerAddModal.png?raw=true" width="100%"></td>
   </tr>
</table>

2. /donate add - Добавление нового задания, при вызове требуется в раскрывающемся списке выбрать категорию, далее следует модальное окно с полями: название, описание, цена, кодовое имя иконки (все доступные иконки и их имена расположены на странице [figma](https://www.figma.com/file/7xSOk7Naw6r44DsP7hsIUB/DonateActivity?type=design&node-id=0-1&mode=design&t=zhfRWXuxi4IxteRw-0) проекта)
<table>
  <tr>
    <td><img src="/img/donateAddSelectType.png?raw=true" width="100%"></td>
    <td><img src="/img/donateAdd.png?raw=true" width="100%"></td>
   </tr>
</table>

3. /donate remove @cost - Удаление донат задания по его цене
4. /donate switch @cost - Вкл/Выкл донат задания по его цене
5. /donate stop - отключение интерактива
6. /donate start - запуск интерактива
7. /donate send @cost @message - отправка тестового задания
8. Контекстная команда Вкл/Выкл игрока
<img src="/img/contextCommand.png?raw=true" width="50%">

## Итоги
Проект был протестирован и аплобирован на трансляциях стримера [Ayoplay](https://vkplay.live/ayoplay), получил высокие оценки от пользователей системы и от самого стримера. Проект является не только успешным в плане работоспособности, но и рентабельности.  

### Планы развития проекта
1. Создание универсального дизайна страниц под ряд возможных игр
2. Разработка public API с возможностью интеграции системы в модификации игр
3. Лендинг с описанием системы
4. Автоматизация подключения стримеров к системе
